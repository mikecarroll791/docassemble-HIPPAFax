---
objects:
  - doc_type: DAList
  - studentattorney: Individual
  - client: Individual
  - parent: Individual
  - hospital: DAObject
  - fax: Individual
---
include:
  - docassemble.AssemblyLine:al_package.yml
  - docassemble.MassAccess:massaccess.yml
---
metadata:
  title: |
    Suffolk Juvenile Defenders
  short title: |
    HIPAA Intake App
  tags:
    - HE-00-00-00-00
---
code: |
  al_form_type = 'existing_case'
---
objects:
  - al_user_bundle: ALDocumentBundle.using(elements=[Authorization_For_Representation_attachment], filename="Authorization_For_Representation.pdf", title="All forms to download for your records")
  - al_court_bundle: ALDocumentBundle.using(elements=[Authorization_For_Representation_attachment], filename="Authorization_For_Representation.pdf", title="All forms to download for your records")
---
mandatory: True
comment: |
  This contains metadata that will not be overwritten if this YAML file is included in another
  file. Each file gets its own key in the interview_metadata dictionary.
  Most keys are not currently used at runtime, other than "allowed courts".
code: |
  interview_metadata
  if not defined("interview_metadata['JDC_HIPAA_Improved']"):
    interview_metadata.initializeObject("JDC_HIPAA_Improved")
    interview_metadata["JDC_HIPAA_Improved"].update({
      "al_weaver_version": "0.81",
      "generated on": "2021-04-19",
      "title": "Suffolk Juvenile Defenders",
      "short title": "HIPAA Intake App",
      "description": "This is the intro",
      "original_form": "",
      "allowed courts": [
      ],
      "categories": [
        "HE-00-00-00-00",
      ],        
      "logic block variable": "interview_order_JDC_HIPAA_Improved",
      "attachment block variable": "JDC_HIPAA_Improved_attachment",
      "typical role": "unknown",
    })
---
code: |
  interview_short_title = "Sign/Submit your client\'s HIPAA release  form"
---
code: |
  al_form_type = 'other_form'
---
objects:
  - parents: ALPeopleList.using(ask_number=True,target_number=1)
  - users: ALPeopleList
---
sections:
  - review_JDC_HIPAA_Improved: Review your answers
---
#################### Interview order #####################
comment: |
  Controls order and branching logic for questions specific to this form
id: interview_order_JDC_HIPAA_Improved
code: |
  # Set the allowed courts for this interview
  al_intro_screen = False
  users.there_is_another= False 
  allowed_courts = interview_metadata["JDC_HIPAA_Improved"]["allowed courts"]
  nav.set_section('review_JDC_HIPAA_Improved')
  user_role = 'defendant'
  user = False
  users[0].address.state = False
  users[0].address.adress = False
  users[0].address.city = False
  users[0].address.zip = False
  Screen_Suffolk_University_HIPAA_App
  advise_client
---
###################### Main order ######################
comment: |
  This block includes the logic for standalone interviews.
  Delete mandatory: True to include in another interview
mandatory: True
code: |
  JDC_HIPAA_Improved_intro
  Screen_Suffolk_University_HIPAA_App
  signature_date
  studentattorney.name.first
  advise_client
  client.name.first
  parent.name.first
  # Save anonymized interview statistics (customize the saved data below)
  store_variables_snapshot(data={'zip': users[0].address.zip})
  #JDC_HIPAA_Improved_preview_question
  basic_questions_signature_flow = False
  client_signature
  parent_signature
  go_to_fax
  hospital.name
  fax_from
  got_result
  all_done
  display_fax_results
  #JDC_HIPAA_Improved_download
---
id: basic questions intro screen
decoration: form-lineal
continue button field: JDC_HIPAA_Improved_intro
question: |
  Sign and Submit Your Client’s HIPAA Release Form: Court Forms Online
subquestion: |

  The Court Forms Online Project can help you complete and fax your client's HIPAA form in 3 steps:
  
  Step 1. Answer questions that will fill in the form for you.  
  Step 2. Preview the completed form.  
  Step 3. Fax the forms to the hospital using this secure website and save copies
  for yourself for later reference.  
  
  Tap the {green words} in any screen for a definition or more information.
  
  % if chat_partners_available().help:
  Live help is currently available in this interview. Click the speech bubble
  (:comment-alt:) in the navigation bar to connect to a live advocate for help.
  % endif
fields:
  - To continue, you must accept our [terms of use](https://courtformsonline.org/privacy/): acknowledged_information_use
    datatype: checkboxes
    none of the above: False    
    minlength: 1
    choices:
      - I accept the terms of use.
    validation messages:
      minlength: |
        You cannot continue unless you agree to the terms of use.   
terms:
  green words: |
    Green words are legal terms or a short way of referring to something that needs more explanation. The definition or explanation pops up when you tap the green words.
right: |
  % if user_has_saved_answers:
  ${fa_icon("bell", color="primary", size="sm")}
  Saved answers available!  
  
  ${action_button_html(url_action('load_answer'), icon="folder-open", label=word("View answers"), size="sm" )}
  % endif    
---
id: Screen Suffolk University HIPAA App
question: |
  Screen Suffolk University HIPAA App
subquestion: |
  This interview will allow your clients to complete this form electronically, and will automatically email you a copy of the completed HIPAA form. When you are done, you can use this app to fax the form to supported hospitals. 
  
  Student Attorney’s are responsible for protecting client information at all times. Suffolk University Law School is not liable for any misuse of this application and releases all liability to any claims that may arise from using this tool.
  
  
  These forms are pursuant to HIPAA Standards of April 14, 2003 (See 45 CFR 164.508(c))
mandatory: True
continue button field: Screen_Suffolk_University_HIPAA_App
---
question: |
  Student Attorney Information
fields: 
  - Student Attorney First Name: studentattorney.name.first
  - Student Attorney Last Name: studentattorney.name.last
---
objects: 
  - studentattorney: Individual
---
id: end of representation 
question: |
  HIPAA form is effective through the end of representation.
subquestion: |
  Advise ${client.name} this form is valid through the end of Suffolk Juvenile Defender Clinic's representation. 
mandatory: True
field: advise_client
---
id: client info
question: |
  Client Information
fields:
  - Client First Name: client.name.first
  - Client Last Name: client.name.last
  - Client Birthday: client.dob
    datatype: date
---
id: Legal Guardian information
question: |
  Legal Guardian Information
fields:
  - First name: parent.name.first
  - Last name: parent.name.last
---
#id: preview JDC_HIPAA_Improved
#question: |
  #Preview your form before you sign it
#subquestion: |
  #Here is a preview of the form you will sign on the next page.   
  
  #${ al_user_bundle.as_pdf(key='preview') }

  #Click the image to open it in a new tab. Click the "Make changes" button
  #to edit your answers.

  #${ action_button_html(url_action('review_" + interview_label + "'), label='Make changes', color='info') }
  
  #Remember to come back to this window to continue and sign your form.
#continue button field: JDC_HIPAA_Improved_preview_question    
---
id: client signature
question: |
  Please have ${ client.name.first } sign their name below.
signature: client_signature
under: |
  ${ client.name }
---
question: |
  Please have ${ parent.name.first } sign their name below.
signature: parent_signature
under: |
  ${ parent.name }
---
id: JDC HIPAA Improved review screen
event: review_JDC_HIPAA_Improved
question: |
  Review your answers
review:
  - Edit: client.name
    button: |
      **Client name full**:
      ${ client.name }
  - Edit: client.dob
    button: |
      **Client dob**:
      ${ client.dob }
  - Edit: todays.date
    button: |
      **Date of todays**:
      ${ todays.date }
  - Edit: client.signature
    button: |
      **Client Signature**:
      ${ client.signature }
---
#id: download JDC_HIPAA_Improved
#event: JDC_HIPAA_Improved_download
#continue button field: go_to_fax
#question: |
  #Your form is ready to download and fax.
#subquestion: |
  
  #Thank you ${ studentattorney.name.first }. Your form is ready to download and fax to the hospital.

  #View, download and send your form below. Click the "Make changes" button to fix any mistakes.

  #${ action_button_html(url_action('review_" + interview_label + "'), label='Make changes', color='info') }

  #${ al_user_bundle.download_list_html() }

  #${ al_user_bundle.send_button_html() }
  
#progress: 90
---
objects:
  - JDC_HIPAA_Improved_attachment: ALDocument.using(title="This is the intro", filename="JDC_HIPAA_Improved.pdf", enabled=True, has_addendum=False)
---
objects:
  - al_user_bundle: ALDocumentBundle.using(elements=[JDC_HIPAA_Improved_attachment], filename="JDC_HIPAA_Improved.pdf", title="All forms to download for your records")
  - al_court_bundle: ALDocumentBundle.using(elements=[JDC_HIPAA_Improved_attachment], filename="JDC_HIPAA_Improved.pdf", title="All forms to download for your records")
---
id:  Fax cover sheet data
question: |
  Fax Cover Sheet
subquestion: |
  The information below will be included on the cover sheet of your fax to the hopsital
fields: 
  - From fax number: fax_from
  - From phone number: fax_phone
  - Fax subject: fax_subject
  - Fax comment: fax_comment
---
id: Fax cover sheet attachment
attachment:
  variable name: Fax_cover_sheet_attachment
  name: Fax_cover_sheet_attachment
  filename: Fax_cover_sheet
  skip undefined: True
  pdf template file: Fax_cover_sheet.pdf
  fields:
      - "hospital.name": ${ hospital.name }
      - "studentattorney.name": ${ studentattorney.name }
      - "hospital.fax": ${ hospital.fax }
      - "fax_from": ${ fax_from }
      - "fax_phone": ${ fax_phone }
      - "hospital.phone": ${ hospital.phone }
      - "todays.date": ${ today() }
      - "fax_subject": ${ fax_subject }
      - "fax_comment": ${ fax_comment }
---
attachment:
  variable name: JDC_HIPAA_Improved_attachment
  name: JDC_HIPAA_Improved_attachment
  filename: JDC_HIPAA_Improved
  skip undefined: True
  pdf template file: JDC_HIPAA_Improved.pdf
  fields:
      - "parent.signature": ${ parent.signature }
      - "client.name": ${ client.name }
      - "parent.name": ${ parent.name }
      - "studentattorney.name": ${ studentattorney.name }
      - "client.dob": ${ client.dob }
      - "todays.date": ${ today() }
      - "todays.date": ${ today() }
      - "todays.date": ${ today() }
      # It's a signature: test which file version this is; leave empty unless it's the final version)
      - "client.signature": ${ client.signature }
---
attachment:
  variable name: Authorization_For_Representation_attachment
  name: Authorization_For_Representation_attachment
  filename: Authorization_For_Representation
  skip undefined: True
  pdf template file: Authorization_For_Representation.pdf
  fields:
      - "client.name": ${ client.name }
      - "client.name": ${ client.name }
      - "client.address.street": ${ client.address.street }
      - "client.address.city": ${ client.address.city }
      - "client.address.zip": ${ client.address.zip }
      - "client.address.state": ${ client.address.state }
      - "docket.numer.1": ${ docket.numer.one }
      - "docket.number.2": ${ docket.number.two }
      - "docket.number.3": ${ docket.number.three }
      - "docket.number.4": ${ docket.number.four }
      - "school_case": ${ school_case }
      - "todays.date": ${ today() }
      - "todays.date": ${ today() }
      - "todays.date": ${ today() }
      - "todays.date": ${ today() }
      - "studentattorney.signature": ${ studentattorney.signature }
      - "parent.signature": ${ parent.signature }
      - "supervisor.signature": ${ supervisor.signature }
---
metadata:
  sessions are unique: True
  required privileges:
    - studentattorney
    - developer
    - admin
---
objects:
  - web: DAWeb.using(base_url='https://api.telnyx.com/v2', json_body=False, on_failure='raise')
---
code: |
  data = {'media_url': "https://apps-dev.suffolklitlab.org/data/templates/JDC_HIPAA_Improved.pdf ",
    'connection_id': '1584353915762115606', 
    'to': hospital_fax_formatted, 
    'from': '+18332979197'}
  headers = {'Authorization': 'Bearer KEY0177F9770F9DA6B296C4098DDA8A8B99_EksqAtVPNAEp4XGMflLPuT',
             'Content-Type': 'application/x-www-form-urlencoded'
             }
  try:
    result = web.post('faxes',
                      data=data,
                      headers=headers, 
                      json_body=False,
                      )
  except DAWebError as e:
    result = e.response_json
  got_result = True                    
---
id: fax endscreen
reload: True
question: |
  This is the end screen.
subquestion: |

  **Below is the response you receieved from the FAX API. "Fax Status:  Queued" indicates the request was successful and the app is working properly**
  
  ${ result }
event: all_done
---
id:  Hospital Information
question: |
  Hospital Information
fields:
  - Name of Hospital/Medical Institution: hospital.name
  - Street: hospital.street
  - City: hospital.city
  - Zip Code: hospital.zip
  - Hospital fax number: hospital.fax
---
code: |
  hospital_fax_formatted = phone_number_in_e164(hospital.fax)
---
code: |
  country: US
--- 
question: |
  **WARNING:** You are about to send a fax. 
subquestion: |
  Your fax  will be sent to ${hospital.fax}. Click on the attached file and review the accuracy of all information before proceeding.

  ${fax_package}
field: got_result
continue button label: SEND FAX
---
code: | 
    fax_package = pdf_concatenate(Fax_cover_sheet_attachment, JDC_HIPAA_Improved_attachment, filename="fax_package.pdf")
---
mandatory: True
question: Your document is ready.
email template: hello_email
email address default: |
  ${ user_email }
attachment:
  - name: A hello world document
    filename: Hello_World
    description: |
      A document with a classic message
    content: |
      Hello, world!
    valid formats:
      - pdf
      - docx
always include editable files: True
---
template: hello_email
subject: |
  Your hello world document
content: |
  Dear sir or madam,

  Your hello world document is attached hereto for your perusal.
---
mandatory: True
question: |
  Here are your documents!
subquestion: |
  ${JDC_HIPAA_Improved_attachment}
  
  ${Authorization_For_Representation_attachment}
attachment code: |
  [JDC_HIPAA_Improved_attachment, Authorization_For_Representation_attachment] 
continue button field: go_to_fax
---
